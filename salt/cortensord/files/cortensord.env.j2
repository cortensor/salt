#===============================================================================
# Cortensor Node Configuration
#===============================================================================
# This is the configuration file for Cortensor Node
# Website: https://cortensor.network
# Discord: https://discord.gg/cortensor
# GitHub: https://github.com/cortensor
#
# IMPORTANT: This file is managed by SaltStack.
# Any changes made here will be overwritten.
#===============================================================================

#===============================================================================
# BLOCKCHAIN CONFIGURATION
#===============================================================================

# RPC Endpoints
#-------------------------------------------------------------------------------
# Arbitrum Sepolia RPC endpoint for testnet
HOST={{ config.get('HOST', 'https://rpc.ankr.com/arbitrum_sepolia/f5f53d9133bbdf13a41ee88d81839470dc49d50dac0d7cf42e14f0045b98630c') }}
CHAINID={{ config.get('CHAINID', '421614') }}

# Ethereum Mainnet RPC endpoint (for reference operations)
HOST_MAINNET={{ config.get('HOST_MAINNET', 'https://rpc.ankr.com/eth/0f4eb65057313c39f6fb51be08f77d42041a2ce92018518c5e02a8358029b4a0') }}

# Smart Contract Addresses
#-------------------------------------------------------------------------------
# TestNet 0 (Current)
CONTRACT_ADDRESS_RUNTIME="{{ config.get('CONTRACT_ADDRESS_RUNTIME', '0xa438cE917a5740267e0f7217f81cbbAA23E7e106') }}"
CONTRACT_ADDRESS_IAM="{{ config.get('CONTRACT_ADDRESS_IAM', '0x146834e5b45832769D8e8Fd0869AD1CEbdF150bD') }}"
CONTRACT_ADDRESS_COGNITIVEV0="{{ config.get('CONTRACT_ADDRESS_COGNITIVEV0', '0x7DEe590Cb7B329e6454Ac78be4213d2D96FF195b') }}"
CONTRACT_ADDRESS_NODESTATS="{{ config.get('CONTRACT_ADDRESS_NODESTATS', '0x593EE6FBb0f7eFbaD8aE17d758878660158af788') }}"
CONTRACT_ADDRESS_NODEREPUTATION="{{ config.get('CONTRACT_ADDRESS_NODEREPUTATION', '0xe62F741249C1eE21E053dac8aC3a7BD66Dc9c773') }}"
CONTRACT_ADDRESS_NODEPOOL="{{ config.get('CONTRACT_ADDRESS_NODEPOOL', '0xFF489a46eeD2733dAa3bEa1e397E8b4ac97C1bb0') }}"
CONTRACT_ADDRESS_ACL="{{ config.get('CONTRACT_ADDRESS_ACL', '0x6Dbc02BD4adbb34caeFb081fe60eDC41e393521B') }}"

# Node Wallet Configuration
#-------------------------------------------------------------------------------
# IMPORTANT: Replace with your actual wallet address and private key
NODE_PUBLIC_KEY={{ config.get('NODE_PUBLIC_KEY', '0x0000000000000000000000000000000000000000') }}
NODE_PRIVATE_KEY={{ config.get('NODE_PRIVATE_KEY', '0x0000000000000000000000000000000000000000000000000000000000000000') }}

#===============================================================================
# NETWORK CONFIGURATION
#===============================================================================

# WebSocket Configuration
#-------------------------------------------------------------------------------
# Router WebSocket endpoints for node communication
WS_HOST_ROUTER="{{ config.get('WS_HOST_ROUTER', '192.168.250.237') }}"
WS_PORT_ROUTER="{{ config.get('WS_PORT_ROUTER', '9001') }}"
AGENT_WS_HOST_ROUTER="{{ config.get('AGENT_WS_HOST_ROUTER', '192.168.250.237') }}"
AGENT_WS_PORT_ROUTER="{{ config.get('AGENT_WS_PORT_ROUTER', '9001') }}"

# Router External IP and Port for Miner Communication
# Used for external access to the router
ROUTER_EXTERNAL_IP="{{ config.get('ROUTER_EXTERNAL_IP', '192.168.250.221') }}"
ROUTER_EXTERNAL_PORT="{{ config.get('ROUTER_EXTERNAL_PORT', '9001') }}"

# Router REST Bind IP and Port for Client Communication
# Reverse proxy to this IP and port
ROUTER_REST_BIND_IP="{{ config.get('ROUTER_REST_BIND_IP', '127.0.0.1') }}"
ROUTER_REST_BIND_PORT="{{ config.get('ROUTER_REST_BIND_PORT', '5010') }}"

# MCP HTTP Server for Router (Streamable MCP over HTTP)
#-------------------------------------------------------------------------------
# Set to 1 to enable the MCP HTTP server inside the router, 0 to disable
ROUTER_MCP={{ config.get('ROUTER_MCP', '0') }}

# Bind IP and port for the MCP HTTP server (used by MCP clients)
ROUTER_MCP_BIND_IP="{{ config.get('ROUTER_MCP_BIND_IP', '127.0.0.1') }}"
ROUTER_MCP_BIND_PORT="{{ config.get('ROUTER_MCP_BIND_PORT', '8001') }}"

# MCP SSE (Legacy) Server for Router (HTTP + Server-Sent Events)
#-------------------------------------------------------------------------------
# Set to 1 to enable the legacy MCP SSE server inside the router, 0 to disable
ROUTER_MCP_SSE={{ config.get('ROUTER_MCP_SSE', '0') }}

# Bind IP and port for the MCP SSE server (used by SSE-capable MCP clients)
ROUTER_MCP_SSE_BIND_IP="{{ config.get('ROUTER_MCP_SSE_BIND_IP', '127.0.0.1') }}"
ROUTER_MCP_SSE_BIND_PORT="{{ config.get('ROUTER_MCP_SSE_BIND_PORT', '8000') }}"

#-------------------------------------------------------------------------------
# x402 Router Node Configuration
# These values control x402 payment settings exposed by the router REST API.
# They correspond to X402Config in the codebase.

# Set to 1 to enable x402 router node payment handling, 0 to disable
X402_ROUTER_NODE_ENABLE={{ config.get('X402_ROUTER_NODE_ENABLE', '0') }}

# Network identifier for x402 payments (e.g. base-sepolia, base)
X402_ROUTER_NODE_NETWORK="{{ config.get('X402_ROUTER_NODE_NETWORK', 'base-sepolia') }}"

# Address that will receive x402 payments (USDC on the configured network)
X402_ROUTER_NODE_PAY_TO="{{ config.get('X402_ROUTER_NODE_PAY_TO', '') }}"

# Default price in USD for generic x402 endpoints (e.g. ping)
X402_ROUTER_NODE_PRICE_DEFAULT="{{ config.get('X402_ROUTER_NODE_PRICE_DEFAULT', '0.001') }}"

# Price in USD specifically for /api/v1/x402/completions/* endpoints
X402_ROUTER_NODE_PRICE_COMPLETIONS="{{ config.get('X402_ROUTER_NODE_PRICE_COMPLETIONS', '0.001') }}"

#===============================================================================
# LLM ENGINE CONFIGURATION
#===============================================================================

# LLM Server Configuration
#-------------------------------------------------------------------------------
LLM_HOST="{{ config.get('LLM_HOST', '127.0.0.1') }}"
LLM_PORT="{{ config.get('LLM_PORT', '8090') }}"

# Memory Management
#-------------------------------------------------------------------------------
# Set to 1 to lock the model in memory for better performance
LLM_OPTION_MLOCK={{ config.get('LLM_OPTION_MLOCK', '1') }}

# Context and Batch Configuration
#-------------------------------------------------------------------------------
# LLM / LLAMA Context Size
# Single Docker LLM Mode / 512
LLM_OPTION_CONTEXT_SIZE={{ config.get('LLM_OPTION_CONTEXT_SIZE', '512') }}

# LLM / LLAMA Batch Size
# Single Docker LLM Mode / 512
LLM_OPTION_BATCH_SIZE={{ config.get('LLM_OPTION_BATCH_SIZE', '512') }}

# GPU Configuration
#-------------------------------------------------------------------------------
# Set to 1 to enable GPU acceleration for the LLM
LLM_OPTION_GPU={{ config.get('LLM_OPTION_GPU', '0') }}
# Threshold for GPU layers (-1 for auto)
# Single Docker LLM Mode
LLM_OPTION_GPU_THRESHOLD={{ config.get('LLM_OPTION_GPU_THRESHOLD', '-1') }}

# Model-specific GPU thresholds (0-40) - Override general GPU threshold for specific models
# Only used when LLM_MEMORY_INDEX_DYNAMIC_LOADING=1 or worker manager is enabled
# -1 for auto, 0 to disable GPU for that model, positive number for specific threshold
{% for i in range(41) %}
LLM_OPTION_MODEL_GPU_THRESHOLD_{{ i }}={{ config.get('LLM_OPTION_MODEL_GPU_THRESHOLD_' ~ i, '-1') }}
{% endfor %}

# CPU Configuration
#-------------------------------------------------------------------------------
# Number of CPU threads to use (-1 for auto)
# 99999 for maximum
LLM_OPTION_CPU_THREADS={{ config.get('LLM_OPTION_CPU_THREADS', '-1') }}

# Docker GPU Configuration
#-------------------------------------------------------------------------------
# Set to 1 to enable GPU support in Docker container
LLM_GPU_CONTAINER={{ config.get('LLM_GPU_CONTAINER', '0') }}
# Specify GPU device IDs to use (e.g., "0,1" or leave empty for all available GPUs)
LLM_GPU_CONTAINER_DEVICE_IDS="{{ config.get('LLM_GPU_CONTAINER_DEVICE_IDS', '') }}"

#===============================================================================
# NODE OPERATION CONFIGURATION
#===============================================================================

# Logging
#-------------------------------------------------------------------------------
LOG_FILE_NAME="{{ config.get('LOG_FILE_NAME', 'agent_miner.log') }}"

# Debug/Development Mode
#-------------------------------------------------------------------------------
# Set to 1 to enable debug print statements
DEV_MODE_ENABLE_DEBUG_PRINT={{ config.get('DEV_MODE_ENABLE_DEBUG_PRINT', '1') }}

# Environment Override
#-------------------------------------------------------------------------------
# Uncomment to override global environment file
# OVERRIDE_GLOBAL_ENV_FILE=path/to/env/file

# IPFS Configuration
#-------------------------------------------------------------------------------
# Set to 1 to enable IPFS in Docker
DOCKER_IPFS={{ config.get('DOCKER_IPFS', '0') }} # Not used

# Set to 1 to enable IPFS server, 0 to disable
ENABLE_IPFS_SERVER={{ config.get('ENABLE_IPFS_SERVER', '1') }}

# LLM Docker Configuration
#-------------------------------------------------------------------------------
# Set to 1 to use Docker for LLM
AGENT_MINER_DOCKER_LLM={{ config.get('AGENT_MINER_DOCKER_LLM', '1') }}
# Set to 1 to automatically start LLM Docker container
AGENT_MINER_DOCKER_LLM_START={{ config.get('AGENT_MINER_DOCKER_LLM_START', '1') }}
# Custom container image for LLM (only used with ENABLE_DEDICATED_NODE=1)
LLM_CONTAINER_IMAGE="{{ config.get('LLM_CONTAINER_IMAGE', '') }}"

# Subprocess model for LLM
LLM_SUBPROCESS_MODEL="{{ config.get('LLM_SUBPROCESS_MODEL', '') }}"

# Dynamic Model Loading Configuration
#-------------------------------------------------------------------------------
LLM_MEMORY_INDEX_DYNAMIC_LOADING_THRESHOLD={{ config.get('LLM_MEMORY_INDEX_DYNAMIC_LOADING_THRESHOLD', '100') }}

# For Dynamic Model Loading, exclude model indexes
LLM_MEMORY_INDEX_DYNAMIC_LOADING_EXCLUDE_MODEL_INDEXES="{{ config.get('LLM_MEMORY_INDEX_DYNAMIC_LOADING_EXCLUDE_MODEL_INDEXES', '') }}"

# Agent Role Configuration
#-------------------------------------------------------------------------------
# Role of this node in the network
AGENT_ROLE={{ config.get('AGENT_ROLE', 'minerv1') }}

# Dedicated Node Configuration
#-------------------------------------------------------------------------------
# Set to 0 to run as an ephemeral node, 1 for dedicated node
ENABLE_DEDICATED_NODE={{ config.get('ENABLE_DEDICATED_NODE', '0') }}
# Comma-separated list of session IDs this node is authorized to serve
DEDICATED_NODE_AUTHORIZED_SESSIONS="{{ config.get('DEDICATED_NODE_AUTHORIZED_SESSIONS', '') }}"

# Queue Mode Configuration
#-------------------------------------------------------------------------------
ENABLE_TX_QUEUE_MODE={{ config.get('ENABLE_TX_QUEUE_MODE', '1') }}
ENABLE_INFERENCE_QUEUE_MODE={{ config.get('ENABLE_INFERENCE_QUEUE_MODE', '0') }}
ENABLE_STREAM_QUEUE_NON_BLOCKING={{ config.get('ENABLE_STREAM_QUEUE_NON_BLOCKING', '0') }}

# Docker Configuration
#-------------------------------------------------------------------------------
# Set to 1 to enable Docker LLM Manager for handling multiple LLM containers, 0 to use single container mode
DOCKER_LLM_MANAGER={{ config.get('DOCKER_LLM_MANAGER', '1') }}

# LLM Worker Configuration
#-------------------------------------------------------------------------------
# Base port for LLM worker instances
LLM_WORKER_BASE_PORT={{ config.get('LLM_WORKER_BASE_PORT', '8090') }}

# Port prefix for LLM worker instances (used for port assignment)
LLM_WORKER_PORT_PREFIX={{ config.get('LLM_WORKER_PORT_PREFIX', '0') }}

# Container name prefix for LLM worker instances (for identification)
LLM_WORKER_CONTAINER_NAME_PREFIX="{{ config.get('LLM_WORKER_CONTAINER_NAME_PREFIX', '') }}"

# LLM Memory Index Dynamic Loading
#-------------------------------------------------------------------------------
LLM_MEMORY_INDEX_DYNAMIC_LOADING={{ config.get('LLM_MEMORY_INDEX_DYNAMIC_LOADING', '1') }}

# LLM Memory Index Buffer Percentage
LLM_MEMORY_INDEX_BUFFER_PERCENTAGE={{ config.get('LLM_MEMORY_INDEX_BUFFER_PERCENTAGE', '20') }}

# LLM Gateway Configuration
#-------------------------------------------------------------------------------
ENABLE_LLM_GATEWAY={{ config.get('ENABLE_LLM_GATEWAY', '0') }}
LLM_GATEWAY_WORKER_BASE_PORT={{ config.get('LLM_GATEWAY_WORKER_BASE_PORT', '18888') }}

# LLM startup timing configuration
#-------------------------------------------------------------------------------
LLM_START_WAIT_SECONDS={{ config.get('LLM_START_WAIT_SECONDS', '10') }}
LLM_START_WAIT_SECONDS_ADDITIONAL_FOR_GPU={{ config.get('LLM_START_WAIT_SECONDS_ADDITIONAL_FOR_GPU', '5') }}

# Polling Intervals
#-------------------------------------------------------------------------------
MINER_PULLING_INTERVAL_SECONDS={{ config.get('MINER_PULLING_INTERVAL_SECONDS', '5') }}

# L3 Configuration
#-------------------------------------------------------------------------------
IS_L3={{ config.get('IS_L3', '0') }}

# Validator V2 Configuration
#-------------------------------------------------------------------------------
LLM_VALIDATOR_V2_EMBEDDING_BATCH_CALL_TIMEOUT={{ config.get('LLM_VALIDATOR_V2_EMBEDDING_BATCH_CALL_TIMEOUT', '60') }}
